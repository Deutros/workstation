---
# This will install all applications and settings for Mac

- name: Ensuring Homebrew Is Installed
  stat:
    path: /usr/local/bin/brew
  register: homebrew_check

- name: Fail If Homebrew Is Not Installed and install_homebrew_if_missing Is False
  fail:
    msg: Homebrew is missing...Install from http://brew.sh/
  when:
    - not homebrew_check.stat.exists
    - not install_homebrew_if_missing

- name: Installing Homebrew
  shell: /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  when:
    - not homebrew_check.stat.exists
    - install_homebrew_if_missing

- name: Install formula with 'brew' from cask
  community.general.homebrew_cask:
    name: "{{ item }}"
    state: present
    update_homebrew: yes
  with_items:
    - homebrew/cask/authy
    - homebrew/cask/google-chrome
    - homebrew/cask/firefox
    - homebrew/cask/nordvpn
    - homebrew/cask/nordpass
    - homebrew/cask/tunnelblick
    - homebrew/cask/visual-studio-code
    - homebrew/cask/sublime-text
    - homebrew/cask/libreoffice
    - homebrew/cask/spotify
    - homebrew/cask/discord
    - homebrew/cask/microsoft-teams
  register: result
  until: result is successful
  when: homebrew_check.stat.exists

- name: Install formula with 'brew' no casks
  community.general.homebrew:
    name: "{{ item }}"
    state: present
    update_homebrew: yes
  with_items:
    - go
    - terraform
    - loginitems #This allows for command line to add startup tools
  register: result
  until: result is successful
  when: homebrew_check.stat.exists

- name: Download Stack
  get_url:
    url: "{{ item.url }}"
    dest: "{ item.dest }}"
    mode: '0440'
  loop:
  - { url: 'https://mirror.transip.net/stack/software/stack-macos-latest.dmg', dest: '~/Downloads/stack.md' }

- name: Install Stack
  ansible.builtin.shell: "{{ item }}"
  with_items:
    - hdiutil attach ~/Downloads/stack.dmg -nobrowse -mountpoint ~/Downloads/stack
    - cp -aR ~/Downloads/stack/*.app /Applications/stack.app
    - hdiutil detach ~/Downloads/stack/

- name: Make sure Stack is booted on start
  community.general.launchd:
    name: com.stack
    state: started
    enabled: yes

- name: Setup bash profile and exports
  blockinfile:
    path: ~/.bash_profile
    block: |
      alias ll="ls -l"
      export PATH=\$PATH:/Users/$USER/Library/Python/3.8/bin/


- name: Create symbolic links
  ansible.builtin.file:
    src: ~/stack/workspace
    dest: ~/workspace
    owner: "{{ macuser }}"
    group: "{{ macuser }}"
    state: link

# TODO
#Configuration
# - Pretty Shell
